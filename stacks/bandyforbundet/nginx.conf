# http-level
map $http_x_forwarded_proto $fastcgi_https {
    default off;
    https  on;
}

server {
  listen 80;
  server_name bandyforbundet.localhost bandyforbundet.no www.bandyforbundet.no;

  # With single shared mount, WordPress lives under /var/www/html
  root /var/www/html;
  index index.php index.html;

  # Allow larger media uploads if needed (adjust as you like)
  client_max_body_size 64m;

  # Static assets
  location ~* \.(jpg|jpeg|png|gif|svg|ico|css|js|woff2?)$ {
    expires max;
    access_log off;
    try_files $uri $uri/ =404;
  }

  # Never execute PHP inside uploads
  location ~* /wp-content/uploads/.*\.php$ {
    deny all;
  }

  # Pretty permalinks / front controller
  location / {
    try_files $uri $uri/ /index.php$is_args$args;
  }

  # PHP-FPM
  location ~ \.php$ {
    include fastcgi_params;                         # base params
    fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;

    # pass real host + HTTPS to PHP behind Traefik
    fastcgi_param HTTP_HOST         $host;
    fastcgi_param X-Forwarded-Proto $http_x_forwarded_proto;
    fastcgi_param HTTPS             $fastcgi_https;

    fastcgi_pass bandy-fpm:9000;
    fastcgi_read_timeout 300;
    fastcgi_buffers 16 16k;
    fastcgi_buffer_size 32k;
  }

  # Let WP handle paths under uploads that aren't real files
  location ^~ /wp-content/uploads/ {
    try_files $uri $uri/ /index.php$is_args$args;
  }

  # Hide dotfiles
  location ~ /\. { deny all; }
}
